local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local runService = game:GetService("RunService")
local userInput = game:GetService("UserInputService")
local camera = workspace.CurrentCamera

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "TemplateGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0.25, 0, 0.45, 0)
mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
mainFrame.BorderColor3 = Color3.fromRGB(255, 255, 255)
mainFrame.BorderSizePixel = 2
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Visible = true
mainFrame.Parent = screenGui

local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 30)
titleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, -60, 1, 0)
titleLabel.Position = UDim2.new(0, 10, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "Exploit GUI"
titleLabel.TextColor3 = Color3.fromRGB(200, 200, 255)
titleLabel.TextScaled = true
titleLabel.Font = Enum.Font.SourceSansBold
titleLabel.Parent = titleBar

local foldInTitle = Instance.new("TextButton")
foldInTitle.Size = UDim2.new(0, 30, 0, 30)
foldInTitle.Position = UDim2.new(1, -40, 0, 0)
foldInTitle.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
foldInTitle.BorderColor3 = Color3.fromRGB(100, 100, 255)
foldInTitle.BorderSizePixel = 1
foldInTitle.Text = "-"
foldInTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
foldInTitle.TextScaled = true
foldInTitle.Parent = titleBar

local foldButton = Instance.new("TextButton")
foldButton.Name = "FoldButton"
foldButton.Size = UDim2.new(0, 50, 0, 50)
foldButton.Position = UDim2.new(0.5, -25, 0.5, -25)
foldButton.AnchorPoint = Vector2.new(0.5, 0.5)
foldButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
foldButton.BorderColor3 = Color3.fromRGB(100, 100, 255)
foldButton.BorderSizePixel = 2
foldButton.Text = "+"
foldButton.TextColor3 = Color3.fromRGB(255, 255, 255)
foldButton.TextScaled = true
foldButton.Font = Enum.Font.SourceSansBold
foldButton.Visible = false
foldButton.Parent = screenGui

local contentFrame = Instance.new("Frame")
contentFrame.Name = "Content"
contentFrame.Size = UDim2.new(1, -10, 1, -40)
contentFrame.Position = UDim2.new(0, 5, 0, 35)
contentFrame.BackgroundTransparency = 1
contentFrame.Parent = mainFrame

local uiList = Instance.new("UIListLayout")
uiList.Padding = UDim.new(0, 5)
uiList.SortOrder = Enum.SortOrder.LayoutOrder
uiList.Parent = contentFrame

local isFolded = false

local function toggleFold()
    isFolded = not isFolded
    mainFrame.Visible = not isFolded
    foldButton.Visible = isFolded
    foldButton.Text = isFolded and "+" or "-"
end

foldInTitle.MouseButton1Click:Connect(toggleFold)
foldButton.MouseButton1Click:Connect(toggleFold)

local fovCircle = Drawing.new("Circle")
fovCircle.Thickness = 2
fovCircle.NumSides = 100
fovCircle.Radius = 150
fovCircle.Color = Color3.fromRGB(255, 100, 100)
fovCircle.Transparency = 1
fovCircle.Visible = false

local settings = {
    SilentAim = false,
    TriggerBot = false,
    ESP = false,
    TeamCheck = true,
    VisibleCheck = true,
    Wallbang = false,
    Prediction = true,
    TargetPart = "Head",
    HitChance = 100
}

local espDrawings = {}  -- [player] = {box, tracer, nameText, healthBarBG, healthBar}

local function createToggle(name, initial, callback)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, 0, 0, 35)
    btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    btn.BorderColor3 = Color3.fromRGB(80, 80, 255)
    btn.BorderSizePixel = 1
    btn.Text = name .. ": " .. (initial and "ON" or "OFF")
    btn.TextColor3 = Color3.fromRGB(200, 200, 255)
    btn.TextScaled = true
    btn.Font = Enum.Font.SourceSans
    btn.Parent = contentFrame
    local active = initial
    btn.MouseButton1Click:Connect(function()
        active = not active
        btn.Text = name .. ": " .. (active and "ON" or "OFF")
        btn.BackgroundColor3 = active and Color3.fromRGB(50, 50, 80) or Color3.fromRGB(30, 30, 30)
        callback(active)
    end)
    return btn
end

createToggle("Silent Aim", false, function(v) settings.SilentAim = v end)
createToggle("TriggerBot", false, function(v) settings.TriggerBot = v end)
createToggle("ESP", false, function(v) settings.ESP = v end)
createToggle("Team Check", true, function(v) settings.TeamCheck = v end)
createToggle("Visible Check", true, function(v) settings.VisibleCheck = v end)
createToggle("Wallbang", false, function(v) settings.Wallbang = v end)
createToggle("Prediction", true, function(v) settings.Prediction = v end)

local fovBtn = createToggle("FOV Circle", false, function(v)
    fovCircle.Visible = v
end)

local function clearESP(player)
    if espDrawings[player] then
        for _, drawing in pairs(espDrawings[player]) do
            drawing:Remove()
        end
        espDrawings[player] = nil
    end
end

local function addESP(player)
    if player == player or not player.Character then return end
    clearESP(player)

    local box = Drawing.new("Square")
    box.Thickness = 2
    box.Filled = false
    box.Transparency = 1

    local tracer = Drawing.new("Line")
    tracer.Thickness = 1
    tracer.Transparency = 1

    local nameText = Drawing.new("Text")
    nameText.Size = 14
    nameText.Center = true
    nameText.Outline = true
    nameText.Transparency = 1

    local healthBG = Drawing.new("Line")
    healthBG.Thickness = 3
    healthBG.Color = Color3.fromRGB(0, 0, 0)
    healthBG.Transparency = 1

    local healthBar = Drawing.new("Line")
    healthBar.Thickness = 2
    healthBar.Transparency = 1

    espDrawings[player] = {box = box, tracer = tracer, nameText = nameText, healthBG = healthBG, healthBar = healthBar}
end

local function updateESP()
    if not settings.ESP then
        for p, _ in pairs(espDrawings) do clearESP(p) end
        return
    end

    for _, p in ipairs(game.Players:GetPlayers()) do
        if p == player then continue end
        local char = p.Character
        if not char or not char:FindFirstChild("Humanoid") or not char:FindFirstChild("HumanoidRootPart") or char.Humanoid.Health <= 0 then
            clearESP(p)
            continue
        end

        if settings.TeamCheck and p.Team == player.Team then
            clearESP(p)
            continue
        end

        if not espDrawings[p] then addESP(p) end
        local drawings = espDrawings[p]

        local rootPos, onScreen = camera:WorldToViewportPoint(char.HumanoidRootPart.Position)
        if not onScreen then
            for _, d in pairs(drawings) do d.Visible = false end
            continue
        end

        local headPos = camera:WorldToViewportPoint((char.Head.CFrame * CFrame.new(0, 1, 0)).Position)
        local legPos = camera:WorldToViewportPoint(char.HumanoidRootPart.Position - Vector3.new(0, 3, 0))
        local sizeY = math.abs(headPos.Y - legPos.Y)
        local sizeX = sizeY * 0.6

        drawings.box.Size = Vector2.new(sizeX, sizeY)
        drawings.box.Position = Vector2.new(rootPos.X - sizeX / 2, rootPos.Y - sizeY / 2)
        drawings.box.Color = settings.TeamCheck and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
        drawings.box.Visible = true

        drawings.tracer.From = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y)
        drawings.tracer.To = Vector2.new(rootPos.X, rootPos.Y)
        drawings.tracer.Color = drawings.box.Color
        drawings.tracer.Visible = true

        drawings.nameText.Text = p.Name .. " [" .. math.floor((player.Character.HumanoidRootPart.Position - char.HumanoidRootPart.Position).Magnitude) .. " studs]"
        drawings.nameText.Position = Vector2.new(rootPos.X, headPos.Y - 20)
        drawings.nameText.Color = drawings.box.Color
        drawings.nameText.Visible = true

        local healthPct = char.Humanoid.Health / char.Humanoid.MaxHealth
        local healthColor = Color3.fromRGB(255 * (1 - healthPct), 255 * healthPct, 0)

        drawings.healthBG.From = Vector2.new(drawings.box.Position.X - 6, drawings.box.Position.Y)
        drawings.healthBG.To = Vector2.new(drawings.box.Position.X - 6, drawings.box.Position.Y + drawings.box.Size.Y)
        drawings.healthBG.Visible = true

        drawings.healthBar.From = Vector2.new(drawings.box.Position.X - 6, drawings.box.Position.Y + drawings.box.Size.Y * (1 - healthPct))
        drawings.healthBar.To = Vector2.new(drawings.box.Position.X - 6, drawings.box.Position.Y + drawings.box.Size.Y)
        drawings.healthBar.Color = healthColor
        drawings.healthBar.Visible = true
    end
end

local closestPlayer = nil

local function getClosest()
    local mousePos = userInput:GetMouseLocation()
    local closest, dist = nil, math.huge
    for _, p in ipairs(game.Players:GetPlayers()) do
        if p == player or not p.Character or not p.Character:FindFirstChild("Humanoid") or p.Character.Humanoid.Health <= 0 then continue end
        if settings.TeamCheck and p.Team == player.Team then continue end
        local part = p.Character:FindFirstChild(settings.TargetPart) or p.Character.HumanoidRootPart
        if not part then continue end
        local screenPos, onScreen = camera:WorldToViewportPoint(part.Position)
        if not onScreen then continue end
        local mag = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
        if mag < dist and mag < fovCircle.Radius then
            local rayParams = RaycastParams.new()
            rayParams.FilterDescendantsInstances = {player.Character}
            rayParams.FilterType = Enum.RaycastFilterType.Exclude
            local rayResult = workspace:Raycast(camera.CFrame.Position, (part.Position - camera.CFrame.Position).Unit * 500, rayParams)
            if (settings.VisibleCheck and rayResult and rayResult.Instance:IsDescendantOf(p.Character)) or settings.Wallbang then
                dist = mag
                closest = p
            end
        end
    end
    return closest
end

local oldRaycast = workspace.Raycast
workspace.Raycast = function(origin, direction, params)
    if settings.SilentAim and closestPlayer and closestPlayer.Character then
        local part = closestPlayer.Character:FindFirstChild(settings.TargetPart) or closestPlayer.Character.HumanoidRootPart
        if part then
            local pred = part.Position
            if settings.Prediction and closestPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local vel = closestPlayer.Character.HumanoidRootPart.Velocity
                pred += vel * 0.135
            end
            local newDir = (pred - origin).Unit * direction.Magnitude
            if math.random(1, 100) <= settings.HitChance then
                return oldRaycast(origin, newDir, params)
            end
        end
    end
    return oldRaycast(origin, direction, params)
end

runService.RenderStepped:Connect(function()
    closestPlayer = getClosest()
    if fovCircle.Visible then
        fovCircle.Position = userInput:GetMouseLocation()
    end
    updateESP()  -- auto refresh ESP every frame

    if settings.TriggerBot and closestPlayer and closestPlayer.Character then
        local part = closestPlayer.Character:FindFirstChild(settings.TargetPart)
        if part then
            local screenPos, _ = camera:WorldToViewportPoint(part.Position)
            local mousePos = userInput:GetMouseLocation()
            if (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude < 40 then
                mouse1press()
                task.wait(math.random(40, 90) / 1000)
                mouse1release()
            end
        end
    end
end)

-- Handle players joining/leaving
game.Players.PlayerAdded:Connect(function(p)
    p.CharacterAdded:Connect(function()
        if settings.ESP then addESP(p) end
    end)
end)

game.Players.PlayerRemoving:Connect(clearESP)

-- Initial players
for _, p in ipairs(game.Players:GetPlayers()) do
    if p ~= player and p.Character then
        if settings.ESP then addESP(p) end
        p.CharacterAdded:Connect(function()
            if settings.ESP then addESP(p) end
        end)
    end
end

player.CharacterAdded:Connect(function()
    task.wait(0.5)
    closestPlayer = getClosest()
end)
